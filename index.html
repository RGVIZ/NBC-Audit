<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Module: Decision Table</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .table-container {
            overflow-x: auto;
        }
        .styled-table {
            border-collapse: separate;
            border-spacing: 0;
        }
        .styled-table th, .styled-table td {
            border: 1px solid #e5e7eb;
            padding: 12px 15px;
            text-align: left;
        }
        .styled-table th {
            background-color: #f3f4f6;
            font-weight: 600;
            color: #1f2937;
            text-transform: uppercase;
            white-space: nowrap;
        }
        .styled-table td {
            background-color: #ffffff;
            transition: background-color 0.2s ease-in-out;
            white-space: nowrap;
        }
        .styled-table tr:hover td {
            background-color: #f9fafb;
        }
        .styled-table input, .styled-table select {
            width: 100%;
            min-width: 100px;
            border: none;
            outline: none;
            padding: 0;
            background-color: transparent;
            font-size: inherit;
            color: inherit;
        }
        /* Custom scrollbar for table container */
        .table-container::-webkit-scrollbar {
            height: 8px;
            background-color: #f1f1f1;
        }
        .table-container::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background-color: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 sm:p-8">

    <div class="w-full max-w-7xl mx-auto bg-white rounded-2xl shadow-xl p-6 sm:p-8 space-y-8">

        <header class="text-center space-y-2">
            <h1 class="text-4xl font-extrabold text-gray-800 tracking-tight">Audit Module</h1>
            <h2 class="text-2xl font-semibold text-gray-600">Decision Table</h2>
        </header>

        <main class="space-y-6">
            <div class="table-container rounded-lg border border-gray-200 overflow-hidden shadow-sm">
                <table class="styled-table min-w-full">
                    <thead>
                        <tr>
                            <th class="w-24">Actions</th>
                            <th>Line</th>
                            <th>Target</th>
                            <th>Assembly PPM</th>
                            <th>% Change</th>
                            <th>Rating (% Change)</th>
                            <th>Customer Complaints</th>
                            <th>Rating (Complaints)</th>
                            <th>Final Rating</th>
                            <th>Frequency</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Table rows will be rendered here by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="addRowBtn" class="flex-1 py-3 px-6 bg-indigo-600 text-white font-medium rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Add Row
                </button>
            </div>
        </main>
    </div>

    <script>
        const TARGET = 4600;
        const lines = ['Line A', 'Line B', 'Line C', 'Line D', 'Line E', 'Line F'];
        const tableBody = document.getElementById('tableBody');
        const addRowBtn = document.getElementById('addRowBtn');

        let tableData = [
            { line: 'Line A', target: TARGET, assemblyPPM: 5000, customerComplaints: 0 },
            { line: 'Line B', target: TARGET, assemblyPPM: 6900, customerComplaints: 1 },
            { line: 'Line C', target: TARGET, assemblyPPM: 4600, customerComplaints: 2 },
            { line: 'Line D', target: TARGET, assemblyPPM: 4800, customerComplaints: 0 },
            { line: 'Line E', target: TARGET, assemblyPPM: 7000, customerComplaints: 5 },
            { line: 'Line F', target: TARGET, assemblyPPM: 5500, customerComplaints: 1 },
        ];

        // Function to calculate all derived values for a single row
        function calculateRow(row) {
            const change = (row.target !== 0) ? ((row.assemblyPPM - row.target) / row.target) * 100 : 0;
            
            const ratingChange = (() => {
                if (change <= 0) return 5;
                if (change > 0 && change <= 50) return 3;
                return 1;
            })();
            
            const ratingComplaints = (() => {
                const complaints = row.customerComplaints;
                if (complaints === 0) return 5;
                if (complaints === 1) return 3;
                return 1;
            })();
            
            const finalRating = ratingChange * ratingComplaints;
            const frequency = finalRating === 25 ? 'Once' : 'Twice';

            return {
                ...row,
                change: change.toFixed(2),
                ratingChange,
                ratingComplaints,
                finalRating,
                frequency,
            };
        }

        // Function to render the entire table from the data
        function renderTable() {
            const html = tableData.map((row, index) => {
                const calculatedRow = calculateRow(row);
                return `
                    <tr>
                        <td>
                            <button onclick="deleteRow(${index})" class="bg-red-500 text-white rounded-md p-1 hover:bg-red-600 transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.214 21H7.786a2 2 0 01-1.927-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </td>
                        <td>
                            <select onchange="updateLine(event, ${index})" class="w-full border-none outline-none p-0 text-gray-800 bg-transparent">
                                <option value="" disabled selected>Select Line</option>
                                ${lines.map(line => `<option value="${line}" ${line === row.line ? 'selected' : ''}>${line}</option>`).join('')}
                            </select>
                        </td>
                        <td><input type="text" value="${calculatedRow.target}" disabled class="data-cell disabled:bg-gray-100 text-gray-500 cursor-not-allowed"></td>
                        <td><input type="number" oninput="updatePPM(event, ${index})" value="${row.assemblyPPM}" placeholder="Enter value..." class="data-cell"></td>
                        <td><input type="text" value="${calculatedRow.change}%" disabled class="data-cell disabled:bg-gray-100 text-gray-500 cursor-not-allowed"></td>
                        <td><input type="text" value="${calculatedRow.ratingChange}" disabled class="data-cell disabled:bg-gray-100 text-gray-500 cursor-not-allowed"></td>
                        <td><input type="number" oninput="updateComplaints(event, ${index})" value="${row.customerComplaints}" placeholder="Enter count..." class="data-cell"></td>
                        <td><input type="text" value="${calculatedRow.ratingComplaints}" disabled class="data-cell disabled:bg-gray-100 text-gray-500 cursor-not-allowed"></td>
                        <td><input type="text" value="${calculatedRow.finalRating}" disabled class="data-cell disabled:bg-gray-100 text-gray-500 cursor-not-allowed"></td>
                        <td><input type="text" value="${calculatedRow.frequency}" disabled class="data-cell disabled:bg-gray-100 text-gray-500 cursor-not-allowed"></td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = html;
        }

        // Functions to handle user input and data updates
        function addRow() {
            tableData.push({
                line: '',
                target: TARGET,
                assemblyPPM: 0,
                customerComplaints: 0,
            });
            renderTable();
        }

        function deleteRow(index) {
            tableData.splice(index, 1);
            renderTable();
        }

        function updatePPM(event, index) {
            tableData[index].assemblyPPM = Number(event.target.value);
            renderTable();
        }

        function updateComplaints(event, index) {
            tableData[index].customerComplaints = Number(event.target.value);
            renderTable();
        }

        function updateLine(event, index) {
            tableData[index].line = event.target.value;
            renderTable();
        }

        // Expose functions to the global scope for `onclick` and `onchange` to work
        window.addRow = addRow;
        window.deleteRow = deleteRow;
        window.updatePPM = updatePPM;
        window.updateComplaints = updateComplaints;
        window.updateLine = updateLine;

        // Attach event listener to the add row button
        addRowBtn.addEventListener('click', addRow);

        // Initial render
        window.onload = renderTable;
    </script>
</body>
</html>
