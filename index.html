<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Audit Planner — Decision Matrix (React + Tailwind CDN)</title>

  <!-- Tailwind CSS CDN (play CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React/ReactDOM via CDN (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel for in-browser JSX compilation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* small helper to allow top-right add inside header */
    .table-header { position: relative; padding-right: 4rem; }
    .add-top-right { position: absolute; right: 0.5rem; top: 0.25rem; }
    /* modal override for big forms */
    .modal-scroll { max-height: 80vh; overflow:auto; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect, useMemo } = React;

  /* ---------- Utilities ---------- */
  const LS_KEYS = { RECORDS: 'auditDecisionRecords_v2', SCHEDULE: 'auditScheduleRecords_v2' };
  const uid = (p='id') => `${p}_${Math.random().toString(36).slice(2,9)}`;
  const nowISO = ()=> new Date().toISOString();
  const round2 = v => Math.round((v + Number.EPSILON) * 100) / 100;

  function loadRecords(){
    try { return JSON.parse(localStorage.getItem(LS_KEYS.RECORDS) || 'null') || []; }
    catch(e){ return []; }
  }
  function saveRecords(arr){
    localStorage.setItem(LS_KEYS.RECORDS, JSON.stringify(arr));
  }
  function loadSchedule(){ try { return JSON.parse(localStorage.getItem(LS_KEYS.SCHEDULE) || 'null') || []; } catch(e){return []}}
  function saveSchedule(arr){ localStorage.setItem(LS_KEYS.SCHEDULE, JSON.stringify(arr)); }

  /* Demo data inserted if empty */
  function ensureDemoData(){
    const existing = loadRecords();
    if (existing.length) return existing;
    const demo = [
      {
        id: uid('dm'),
        name: 'Line A - Quarterly',
        appliesTo: 'Line',
        appliesToDetail: 'Line A',
        coordinator: 'A. Kumar',
        description: 'Decision matrix for Line A - Q2',
        createdAt: nowISO(),
        updatedAt: nowISO(),
        rows:[
          { rowId: uid('r'), appliesToInstance: 'Line A', targetPPM: 100, actualPPM: 90, complaints: 3, saved: true },
          { rowId: uid('r'), appliesToInstance: 'Line A', targetPPM: 200, actualPPM: 150, complaints: 0, saved: true }
        ],
        rules:{
          pctChangeRules:[
            { ruleId: uid('pr'), operation:'in_between', min:-999, max:0, value:null, rating:1, description:'1 - Excellent' },
            { ruleId: uid('pr'), operation:'in_between', min:0.0001, max:20, value:null, rating:2, description:'2 - Good' },
            { ruleId: uid('pr'), operation:'gt', min:null, max:null, value:20, rating:3, description:'3 - Poor' }
          ],
          complaintRules:[
            { ruleId: uid('cr'), operation:'eq', min:null, max:null, value:0, rating:0, description:'0 - No Complaints' },
            { ruleId: uid('cr'), operation:'gte', min:null, max:null, value:1, rating:1, description:'1 - Some Complaints' },
            { ruleId: uid('cr'), operation:'gt', min:null, max:null, value:5, rating:2, description:'2 - Many Complaints' }
          ],
          frequencyRules:[
            { ruleId: uid('fr'), operation:'in_between', min:0, max:1, value:null, frequency:'Daily', color:'#DC2626' },
            { ruleId: uid('fr'), operation:'in_between', min:1.0001, max:2, value:null, frequency:'Weekly', color:'#2563EB' },
            { ruleId: uid('fr'), operation:'in_between', min:2.0001, max:5, value:null, frequency:'Monthly', color:'#059669' },
            { ruleId: uid('fr'), operation:'gt', min:null, max:null, value:5, frequency:'Yearly', color:'#1E40AF' }
          ]
        }
      },
      {
        id: uid('dm'),
        name: 'Supplier - Acme Ltd',
        appliesTo: 'Supplier',
        appliesToDetail: 'Acme Ltd',
        coordinator: 'S. Patel',
        description: 'Quarterly supplier monitoring',
        createdAt: nowISO(),
        updatedAt: nowISO(),
        rows: [],
        rules:{
          pctChangeRules:[
            { ruleId: uid('pr'), operation:'lte', min:null, max:null, value:5, rating:1, description:'1 - Target met' },
            { ruleId: uid('pr'), operation:'gt', min:null, max:null, value:5, rating:2, description:'2 - Above threshold' }
          ],
          complaintRules:[
            { ruleId: uid('cr'), operation:'eq', min:null, max:null, value:0, rating:0, description:'0 - No Complaints' },
            { ruleId: uid('cr'), operation:'gte', min:null, max:null, value:1, rating:1, description:'1 - Complaints present' }
          ],
          frequencyRules:[
            { ruleId: uid('fr'), operation:'gte', min:null, max:null, value:2, frequency:'Monthly', color:'#2563EB' },
            { ruleId: uid('fr'), operation:'lt', min:null, max:null, value:2, frequency:'Yearly', color:'#059669' }
          ]
        }
      }
    ];
    saveRecords(demo);
    return demo;
  }

  /* ---------- Evaluation helpers ---------- */
  function opLabel(op){
    switch(op){
      case 'in_between': return 'In Between';
      case 'gte': return '>='; case 'lte': return '<='; case 'gt': return '>'; case 'lt': return '<'; case 'eq': return '=';
      default: return op;
    }
  }

  function evaluateRating(rules, value){
    if (!Array.isArray(rules) || value === null || value === undefined) return null;
    for (const r of rules){
      if (r.operation === 'in_between'){
        if (value >= Number(r.min) && value <= Number(r.max)) return tryParseNumber(r.rating);
      } else {
        const v = Number(r.value);
        if (r.operation === 'gte' && value >= v) return tryParseNumber(r.rating);
        if (r.operation === 'lte' && value <= v) return tryParseNumber(r.rating);
        if (r.operation === 'gt' && value > v) return tryParseNumber(r.rating);
        if (r.operation === 'lt' && value < v) return tryParseNumber(r.rating);
        if (r.operation === 'eq' && value === v) return tryParseNumber(r.rating);
      }
    }
    return null;
  }
  function tryParseNumber(x){ const n = Number(x); return Number.isFinite(n) ? n : x }

  function evaluateFrequency(freqRules, finalRating){
    if (!Array.isArray(freqRules) || finalRating === null || finalRating === undefined) return null;
    for (const r of freqRules){
      if (r.operation === 'in_between'){
        if (finalRating >= Number(r.min) && finalRating <= Number(r.max)) return { frequency: r.frequency, color: r.color };
      } else {
        const v = Number(r.value);
        if (r.operation === 'gte' && finalRating >= v) return { frequency: r.frequency, color: r.color };
        if (r.operation === 'lte' && finalRating <= v) return { frequency: r.frequency, color: r.color };
        if (r.operation === 'gt' && finalRating > v) return { frequency: r.frequency, color: r.color };
        if (r.operation === 'lt' && finalRating < v) return { frequency: r.frequency, color: r.color };
        if (r.operation === 'eq' && finalRating === v) return { frequency: r.frequency, color: r.color };
      }
    }
    return null;
  }

  function calcPctChange(target, actual){
    if (target === null || target === undefined || target === 0) return null;
    if (actual === null || actual === undefined) return null;
    return round2(((target - actual) / target) * 100);
  }

  /* ---------- App ---------- */
  function App(){
    const [records, setRecords] = useState(() => ensureDemoData());
    const [route, setRoute] = useState(() => {
      const h = location.hash || '#/list';
      return h;
    });

    useEffect(()=> { // listen to hash changes
      const onHash = ()=> setRoute(location.hash || '#/list');
      window.addEventListener('hashchange', onHash);
      return ()=> window.removeEventListener('hashchange', onHash);
    },[]);

    useEffect(()=> saveRecords(records), [records]);

    function createRecord(payload){
      const rec = {
        id: uid('dm'),
        name: payload.name,
        appliesTo: payload.appliesTo,
        appliesToDetail: payload.detail || '',
        coordinator: payload.coordinator,
        description: payload.description || '',
        createdAt: nowISO(),
        updatedAt: nowISO(),
        rows: [],
        rules: { pctChangeRules: [], complaintRules: [], frequencyRules: [] }
      };
      setRecords(prev=>[...prev, rec]);
      location.hash = '#/record/' + rec.id;
    }

    function updateRecord(id, patch){
      setRecords(prev => prev.map(r => r.id === id ? ({ ...patch, updatedAt: nowISO() }) : r));
    }

    function removeRecord(id){
      if (!confirm('Delete this record?')) return;
      setRecords(prev => prev.filter(r => r.id !== id));
      location.hash = '#/list';
    }

    function sendToSchedule(id){
      const rec = records.find(r=>r.id===id);
      if (!rec) return alert('Record missing');
      const schedule = loadSchedule();
      const copy = JSON.parse(JSON.stringify(rec));
      copy.sentAt = nowISO();
      schedule.push(copy);
      saveSchedule(schedule);
      alert('Record sent to Audit Schedule (in localStorage).');
    }

    // route parsing
    if (route.startsWith('#/record/')){
      const id = route.split('/')[2];
      const rec = records.find(r=>r.id===id);
      if (!rec) {
        // show not found and back link
        return (
          <Layout>
            <div className="p-6">
              <div className="bg-white rounded-lg p-6 shadow">
                <h2 className="text-lg font-semibold">Record not found</h2>
                <p className="text-sm text-gray-500 mt-2">It may have been deleted.</p>
                <button className="mt-4 px-4 py-2 bg-blue-600 text-white rounded" onClick={()=> location.hash='#/list'}>Back to Listing</button>
              </div>
            </div>
          </Layout>
        );
      }
      return (
        <Layout>
          <RecordView
            record={rec}
            onUpdate={(patched)=> updateRecord(rec.id, patched)}
            onDelete={()=> removeRecord(rec.id)}
            onSend={()=> sendToSchedule(rec.id)}
          />
        </Layout>
      );
    }

    if (route === '#/schedule') {
      return (
        <Layout>
          <ScheduleView />
        </Layout>
      );
    }

    // default listing view
    return (
      <Layout>
        <ListingView
          records={records}
          onCreate={createRecord}
          onEdit={(id)=> { location.hash = '#/record/' + id } }
          onDelete={removeRecord}
          onView={(id)=> { location.hash = '#/record/' + id }}
        />
      </Layout>
    );
  }

  /* ---------- Layout + Sidebar ---------- */
  function Layout({ children }){
    return (
      <div className="min-h-screen flex">
        <aside className="w-64 bg-blue-800 text-white p-6">
          <div className="text-lg font-semibold mb-6">Audit Planner</div>
          <nav className="space-y-1">
            <a href="#/list" className={"block px-3 py-2 rounded " + (location.hash.startsWith('#/list') || location.hash === '' ? 'bg-blue-600' : 'hover:bg-blue-700')}>Audit Decision Matrix</a>
            <a href="#/schedule" className={"block px-3 py-2 rounded hover:bg-blue-700"}>Audit Schedule</a>
          </nav>
        </aside>
        <main className="flex-1 p-6">
          {children}
        </main>
      </div>
    );
  }

  /* ---------- Listing View (Create modal + List) ---------- */
  function ListingView({ records, onCreate, onDelete, onView }){
    const [showCreate, setShowCreate] = useState(false);
    const [form, setForm] = useState({ name:'', appliesTo:'Line', detail:'', coordinator:'', description:'' });

    const resetForm = ()=> setForm({ name:'', appliesTo:'Line', detail:'', coordinator:'', description:'' });

    useEffect(()=> {
      // open create when user clicked + from query? not required
    },[]);

    function handleCreate(){
      if (!form.name.trim() || !form.coordinator.trim()) return alert('Name and Coordinator required');
      onCreate(form);
      resetForm();
      setShowCreate(false);
    }

    return (
      <div>
        <div className="flex items-center justify-between mb-6">
          <div>
            <h1 className="text-2xl font-bold text-blue-700">Audit Decision Matrix</h1>
            <p className="text-sm text-gray-600 mt-1">Create and manage decision matrix records</p>
          </div>
          <div>
            <button className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded" onClick={()=> setShowCreate(true)}>+ Add Record</button>
          </div>
        </div>

        <div className="space-y-4">
          {records.length === 0
            ? <div className="bg-white p-6 rounded shadow text-gray-500">No records. Click + Add Record to create one.</div>
            : records.slice().reverse().map(rec => (
              <div key={rec.id} className="bg-white p-4 rounded shadow flex items-center justify-between">
                <div>
                  <div className="text-lg font-semibold">{rec.name}</div>
                  <div className="text-sm text-gray-500">Applies to: <span className="font-medium">{rec.appliesTo}{rec.appliesToDetail ? ` (${rec.appliesToDetail})`: ''}</span> • Coordinator: <span className="font-medium">{rec.coordinator}</span></div>
                </div>
                <div className="space-x-2">
                  <button className="px-3 py-1 bg-white border border-blue-600 text-blue-600 rounded" onClick={()=> onView(rec.id)}>View</button>
                  <button className="px-3 py-1 bg-gray-100 text-gray-700 rounded" onClick={()=> { location.hash = '#/record/' + rec.id }}>Edit</button>
                  <button className="px-3 py-1 bg-red-600 text-white rounded" onClick={()=> onDelete(rec.id)}>Delete</button>
                </div>
              </div>
            ))
          }
        </div>

        {/* Create Modal */}
        {showCreate && (
          <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
            <div className="bg-white rounded-lg shadow-lg w-[720px] modal-scroll p-6">
              <h3 className="text-lg font-semibold mb-2">Create New Decision Matrix</h3>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="text-sm font-medium">Name *</label>
                  <input value={form.name} onChange={(e)=> setForm({...form,name:e.target.value})} className="mt-1 w-full border rounded px-3 py-2"/>
                </div>
                <div>
                  <label className="text-sm font-medium">Coordinator *</label>
                  <input value={form.coordinator} onChange={(e)=> setForm({...form,coordinator:e.target.value})} className="mt-1 w-full border rounded px-3 py-2"/>
                </div>
                <div>
                  <label className="text-sm font-medium">Applies To</label>
                  <select value={form.appliesTo} onChange={(e)=> setForm({...form,appliesTo:e.target.value})} className="mt-1 w-full border rounded px-3 py-2">
                    <option>Line</option>
                    <option>Plant</option>
                    <option>Supplier</option>
                  </select>
                </div>
                <div>
                  <label className="text-sm font-medium">Applies To Detail (optional)</label>
                  <input value={form.detail} onChange={(e)=> setForm({...form,detail:e.target.value})} className="mt-1 w-full border rounded px-3 py-2" placeholder="Line identifier / Plant code / Supplier name"/>
                </div>
                <div className="col-span-2">
                  <label className="text-sm font-medium">Description (optional)</label>
                  <textarea value={form.description} onChange={(e)=> setForm({...form,description:e.target.value})} className="mt-1 w-full border rounded px-3 py-2" rows="3"/>
                </div>
              </div>

              <div className="mt-4 flex justify-end gap-2">
                <button className="px-4 py-2 rounded bg-gray-200" onClick={()=> setShowCreate(false)}>Cancel</button>
                <button className="px-4 py-2 rounded bg-blue-600 text-white" onClick={handleCreate}>Create</button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }

  /* ---------- Record View (full page) ---------- */
  function RecordView({ record, onUpdate, onDelete, onSend }){
    // maintain a local copy so edits are immediate; persist by calling onUpdate
    const [rec, setRec] = useState(() => JSON.parse(JSON.stringify(record)));
    const [editingRowId, setEditingRowId] = useState(null);
    const [showRulesModal, setShowRulesModal] = useState(false);
    const [showEditMeta, setShowEditMeta] = useState(false);

    // recalc whenever rec.rows or rec.rules change
    useEffect(()=> {
      // compute derived fields for each row
      const newRows = (rec.rows || []).map(r => {
        const t = r.targetPPM === '' || r.targetPPM === null || r.targetPPM === undefined ? null : Number(r.targetPPM);
        const a = r.actualPPM === '' || r.actualPPM === null || r.actualPPM === undefined ? null : Number(r.actualPPM);
        const complaints = r.complaints === '' || r.complaints === null || r.complaints === undefined ? null : Number(r.complaints);
        const pct = calcPctChange(t, a);
        const pctRating = evaluateRating(rec.rules.pctChangeRules||[], pct);
        const compRating = evaluateRating(rec.rules.complaintRules||[], complaints);
        const finalRating = (typeof pctRating === 'number' && typeof compRating === 'number') ? round2(pctRating * compRating) : null;
        const freqObj = evaluateFrequency(rec.rules.frequencyRules||[], finalRating);
        return {
          ...r,
          targetPPM: t,
          actualPPM: a,
          complaints,
          pctChange: pct,
          pctChangeRating: pctRating,
          complaintRating: compRating,
          finalRating,
          frequency: freqObj ? freqObj.frequency : null,
          frequencyColor: freqObj ? freqObj.color : null
        };
      });
      // update without overwriting other user edits: setRec with new rows
      setRec(prev => ({ ...prev, rows: newRows }));
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [/* rec.rules or rec.rows change should recalc; since rec is state var, add rec.rules & rec.rows length as dependencies */ rec.rules, JSON.stringify(rec.rows)]);

    function persist(){
      onUpdate(rec);
    }

    function addRow(){
      const newRow = {
        rowId: uid('r'),
        appliesToInstance: rec.appliesToDetail || rec.appliesTo,
        targetPPM: null,
        actualPPM: null,
        complaints: null,
        saved: false
      };
      setRec(prev => ({ ...prev, rows: [newRow, ...(prev.rows||[])] }));
      setEditingRowId(newRow.rowId);
    }

    function saveRow(row){
      // mark saved (true) and persist
      const rows = (rec.rows||[]).map(r => r.rowId === row.rowId ? ({ ...r, saved: true }) : r);
      setRec(prev=> ({ ...prev, rows }));
      setEditingRowId(null);
      // update parent store
      onUpdate({ ...rec, rows });
    }

    function deleteRow(rowId){
      if (!confirm('Delete this row?')) return;
      const rows = (rec.rows||[]).filter(r=> r.rowId !== rowId);
      setRec(prev => ({ ...prev, rows }));
      onUpdate({ ...rec, rows });
    }

    function onRowChange(rowId, field, value){
      const rows = (rec.rows||[]).map(r => r.rowId === rowId ? ({ ...r, [field]: value }) : r);
      setRec(prev => ({ ...prev, rows }));
    }

    function openRulesModal(){ setShowRulesModal(true); }
    function saveRules(newRules){
      setRec(prev => ({ ...prev, rules: newRules }));
      onUpdate({ ...rec, rules: newRules });
      setShowRulesModal(false);
    }

    function openEditMeta(){ setShowEditMeta(true); }
    function saveMeta(meta){
      const patched = { ...rec, ...meta };
      setRec(patched);
      onUpdate(patched);
      setShowEditMeta(false);
    }

    function handleSend(){
      onSend();
    }

    return (
      <div>
        <div className="mb-4">
          <div className="flex items-center justify-between">
            <div>
              <h2 className="text-2xl font-bold text-blue-700">{rec.name}</h2>
              <div className="text-sm text-gray-600 mt-1">Applies to: <span className="font-medium">{rec.appliesTo}{rec.appliesToDetail ? ` (${rec.appliesToDetail})` : ''}</span> | Coordinator: <span className="font-medium">{rec.coordinator}</span></div>
            </div>
            <div className="space-x-2">
              <button className="px-3 py-2 bg-gray-100 rounded" onClick={openEditMeta}>Edit</button>
              <button className="px-3 py-2 bg-red-600 text-white rounded" onClick={()=> { if(confirm('Delete record?')) onDelete() }}>Delete</button>
              <a className="px-3 py-2 bg-white border border-gray-200 rounded" href="#/list">Back to Listing</a>
            </div>
          </div>
        </div>

        {/* Rules Banner */}
        <div className="grid grid-cols-3 gap-4 mb-4">
          <div className="bg-white p-4 rounded shadow">
            <div className="flex justify-between items-start">
              <div>
                <div className="font-semibold mb-2">% Change Rating Rules</div>
                <div className="text-sm text-gray-700">
                  { (rec.rules?.pctChangeRules || []).length === 0 ? <div className="text-gray-400">No rules defined</div>
                    : (rec.rules.pctChangeRules.map(r=> (<div key={r.ruleId}>{String(r.rating)} - {r.description || ''} ({opLabel(r.operation)} {r.operation==='in_between' ? `${r.min} - ${r.max}` : r.value})</div>))) }
                </div>
              </div>
            </div>
          </div>

          <div className="bg-white p-4 rounded shadow">
            <div className="font-semibold mb-2">Complaint Rating Rules</div>
            <div className="text-sm text-gray-700">
              { (rec.rules?.complaintRules || []).length === 0 ? <div className="text-gray-400">No rules defined</div>
                : (rec.rules.complaintRules.map(r=> (<div key={r.ruleId}>{String(r.rating)} - {r.description || ''} ({opLabel(r.operation)} {r.operation==='in_between' ? `${r.min} - ${r.max}` : r.value})</div>)))}
            </div>
          </div>

          <div className="bg-white p-4 rounded shadow relative">
            <div className="flex justify-between items-start">
              <div>
                <div className="font-semibold mb-2">Frequency Rules</div>
                <div className="text-sm text-gray-700">
                  { (rec.rules?.frequencyRules || []).length === 0 ? <div className="text-gray-400">No rules defined</div>
                    : (rec.rules.frequencyRules.map(r=> (<div key={r.ruleId}><span className="inline-block px-2 py-1 rounded text-xs text-white" style={{background: r.color || '#1D4ED8'}}>{r.frequency}</span> &nbsp; {r.operation==='in_between' ? `${r.min} - ${r.max}` : r.value}</div>)))
                  }
                </div>
              </div>
              <div>
                <button className="px-3 py-1 bg-blue-600 text-white rounded" onClick={openRulesModal}>Configure Rules</button>
              </div>
            </div>
          </div>
        </div>

        {/* Decision Matrix Table */}
        <div className="bg-white rounded shadow p-4">
          <div className="table-header mb-2 relative">
            <div className="text-sm font-semibold">Decision Matrix</div>
            <button className="add-top-right px-3 py-1 bg-blue-600 text-white rounded" onClick={addRow}>+ Add Row</button>
          </div>

          <div className="overflow-x-auto">
            <table className="min-w-full border-collapse text-sm">
              <thead>
                <tr className="bg-blue-50 text-left">
                  <th className="p-2 border">Applies To Instance</th>
                  <th className="p-2 border">Target PPM</th>
                  <th className="p-2 border">Actual PPM</th>
                  <th className="p-2 border">% Change</th>
                  <th className="p-2 border">PPM Rating</th>
                  <th className="p-2 border">Complaints</th>
                  <th className="p-2 border">Complaint Rating</th>
                  <th className="p-2 border">Final Rating</th>
                  <th className="p-2 border">Frequency</th>
                  <th className="p-2 border">Action</th>
                </tr>
              </thead>
              <tbody>
                { (rec.rows || []).map(row => (
                  <tr key={row.rowId} className="hover:bg-gray-50">
                    <td className="p-2 border">
                      <input value={row.appliesToInstance || ''} onChange={(e)=> onRowChange(row.rowId, 'appliesToInstance', e.target.value)} className="border rounded px-2 py-1 w-44"/>
                    </td>
                    <td className="p-2 border"><input type="number" value={row.targetPPM ?? ''} onChange={(e)=> onRowChange(row.rowId, 'targetPPM', e.target.value === '' ? null : Number(e.target.value))} className="border rounded px-2 py-1 w-28"/></td>
                    <td className="p-2 border"><input type="number" value={row.actualPPM ?? ''} onChange={(e)=> onRowChange(row.rowId, 'actualPPM', e.target.value === '' ? null : Number(e.target.value))} className="border rounded px-2 py-1 w-28"/></td>
                    <td className="p-2 border">{ row.pctChange === null ? 'N/A' : String(row.pctChange) + '%' }</td>
                    <td className="p-2 border">{ row.pctChangeRating === null ? '' : String(row.pctChangeRating) }</td>
                    <td className="p-2 border"><input type="number" value={row.complaints ?? ''} onChange={(e)=> onRowChange(row.rowId, 'complaints', e.target.value === '' ? null : Number(e.target.value))} className="border rounded px-2 py-1 w-20"/></td>
                    <td className="p-2 border">{ row.complaintRating === null ? '' : String(row.complaintRating) }</td>
                    <td className="p-2 border">{ row.finalRating === null ? '' : String(row.finalRating) }</td>
                    <td className="p-2 border">{ row.frequency ? (<span className="px-2 py-1 rounded text-white text-xs" style={{background: row.frequencyColor}}>{row.frequency}</span>) : '' }</td>
                    <td className="p-2 border">
                      <div className="flex gap-2">
                        {!row.saved ? (
                          <button className="px-2 py-1 bg-blue-600 text-white rounded" onClick={()=> saveRow(row)}>Save</button>
                        ) : (
                          <button className="px-2 py-1 bg-gray-100 rounded" onClick={()=> setEditingRowId(row.rowId === editingRowId ? null : row.rowId)}>{ editingRowId === row.rowId ? 'Close' : 'Edit' }</button>
                        )}
                        <button className="px-2 py-1 bg-red-600 text-white rounded" onClick={()=> deleteRow(row.rowId)}>Delete</button>
                      </div>
                    </td>
                  </tr>
                )) }
              </tbody>
            </table>
          </div>

          <div className="mt-4">
            <button className="px-4 py-2 bg-blue-600 text-white rounded" onClick={handleSend}>Send to Schedule</button>
          </div>
        </div>

        {/* Rules Modal */}
        { showRulesModal && (
          <RulesModal rules={rec.rules} onClose={()=> setShowRulesModal(false)} onSave={(r)=> saveRules(r)} />
        )}

        {/* Edit Meta Modal */}
        { showEditMeta && (
          <EditMetaModal meta={{ name: rec.name, appliesTo: rec.appliesTo, appliesToDetail: rec.appliesToDetail, coordinator: rec.coordinator, description: rec.description }} onCancel={()=> setShowEditMeta(false)} onSave={(m)=> saveMeta(m)} />
        )}
      </div>
    );
  }

  /* ---------- Rules Modal Component ---------- */
  function RulesModal({ rules, onClose, onSave }){
    // local copy to edit
    const [local, setLocal] = useState(() => JSON.parse(JSON.stringify(rules || { pctChangeRules:[], complaintRules:[], frequencyRules:[] })));

    function addPct(){ setLocal(prev => ({ ...prev, pctChangeRules: [{ ruleId: uid('pr'), operation:'in_between', min:0, max:0, value:null, rating: '', description: ''}, ...(prev.pctChangeRules||[]) ] })); }
    function addComplaint(){ setLocal(prev => ({ ...prev, complaintRules: [{ ruleId: uid('cr'), operation:'in_between', min:0, max:0, value:null, rating:'', description: ''}, ...(prev.complaintRules||[]) ] })); }
    function addFreq(){ setLocal(prev => ({ ...prev, frequencyRules: [{ ruleId: uid('fr'), operation:'in_between', min:0, max:0, value:null, frequency:'Monthly', color:'#2563EB' }, ...(prev.frequencyRules||[]) ] })); }

    function updateRuleList(listKey, idx, field, value){
      const copy = JSON.parse(JSON.stringify(local));
      copy[listKey][idx][field] = value;
      setLocal(copy);
    }
    function deleteRule(listKey, idx){
      if (!confirm('Delete this rule?')) return;
      const copy = JSON.parse(JSON.stringify(local));
      copy[listKey].splice(idx,1);
      setLocal(copy);
    }

    return (
      <div className="fixed inset-0 z-50 flex items-start justify-center pt-12">
        <div className="absolute inset-0 bg-black/40" onClick={onClose}></div>
        <div className="bg-white rounded-lg shadow-lg w-[900px] max-w-[95%] p-6 z-10 modal-scroll">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-lg font-semibold">Configure Rules</h3>
            <div className="flex gap-2">
              <button className="px-3 py-1 bg-gray-200 rounded" onClick={onClose}>Cancel</button>
              <button className="px-3 py-1 bg-blue-600 text-white rounded" onClick={()=> onSave(local)}>Save Rules</button>
            </div>
          </div>

          <div className="grid grid-cols-3 gap-4">
            <div>
              <div className="flex justify-between items-center mb-2">
                <div className="font-semibold"> % Change Rating Rules</div>
                <button className="px-2 py-1 bg-blue-600 text-white rounded text-sm" onClick={addPct}>+ Add</button>
              </div>

              <div className="space-y-2">
                { (local.pctChangeRules||[]).map((r, i)=> (
                  <div key={r.ruleId} className="border rounded p-2">
                    <div className="flex gap-2">
                      <select value={r.operation} onChange={(e)=> updateRuleList('pctChangeRules', i, 'operation', e.target.value)} className="border px-2 py-1 rounded">
                        <option value="in_between">In Between</option>
                        <option value="gte">Greater than or Equal to</option>
                        <option value="lte">Less than or Equal to</option>
                        <option value="gt">Greater than</option>
                        <option value="lt">Less than</option>
                        <option value="eq">Equal to</option>
                      </select>
                      <input type="number" value={r.min ?? ''} onChange={(e)=> updateRuleList('pctChangeRules', i, 'min', e.target.value === '' ? null : Number(e.target.value))} placeholder="Min" className="border px-2 py-1 rounded w-20"/>
                      <input type="number" value={r.max ?? ''} onChange={(e)=> updateRuleList('pctChangeRules', i, 'max', e.target.value === '' ? null : Number(e.target.value))} placeholder="Max" className="border px-2 py-1 rounded w-20"/>
                      <input type="number" value={r.value ?? ''} onChange={(e)=> updateRuleList('pctChangeRules', i, 'value', e.target.value === '' ? null : Number(e.target.value))} placeholder="Value" className="border px-2 py-1 rounded w-20"/>
                      <input value={r.rating} onChange={(e)=> updateRuleList('pctChangeRules', i, 'rating', e.target.value)} placeholder="Rating" className="border px-2 py-1 rounded w-20"/>
                    </div>
                    <div className="mt-2 flex gap-2">
                      <input value={r.description || ''} onChange={(e)=> updateRuleList('pctChangeRules', i, 'description', e.target.value)} placeholder="Description" className="border px-2 py-1 rounded flex-1"/>
                      <button className="px-2 py-1 bg-red-600 text-white rounded" onClick={()=> deleteRule('pctChangeRules', i)}>Delete</button>
                    </div>
                  </div>
                )) }
              </div>
            </div>

            <div>
              <div className="flex justify-between items-center mb-2">
                <div className="font-semibold"> Complaint Rating Rules</div>
                <button className="px-2 py-1 bg-blue-600 text-white rounded text-sm" onClick={addComplaint}>+ Add</button>
              </div>

              <div className="space-y-2">
                { (local.complaintRules||[]).map((r, i)=> (
                  <div key={r.ruleId} className="border rounded p-2">
                    <div className="flex gap-2">
                      <select value={r.operation} onChange={(e)=> updateRuleList('complaintRules', i, 'operation', e.target.value)} className="border px-2 py-1 rounded">
                        <option value="in_between">In Between</option>
                        <option value="gte">Greater than or Equal to</option>
                        <option value="lte">Less than or Equal to</option>
                        <option value="gt">Greater than</option>
                        <option value="lt">Less than</option>
                        <option value="eq">Equal to</option>
                      </select>
                      <input type="number" value={r.min ?? ''} onChange={(e)=> updateRuleList('complaintRules', i, 'min', e.target.value === '' ? null : Number(e.target.value))} placeholder="Min" className="border px-2 py-1 rounded w-20"/>
                      <input type="number" value={r.max ?? ''} onChange={(e)=> updateRuleList('complaintRules', i, 'max', e.target.value === '' ? null : Number(e.target.value))} placeholder="Max" className="border px-2 py-1 rounded w-20"/>
                      <input type="number" value={r.value ?? ''} onChange={(e)=> updateRuleList('complaintRules', i, 'value', e.target.value === '' ? null : Number(e.target.value))} placeholder="Value" className="border px-2 py-1 rounded w-20"/>
                      <input value={r.rating} onChange={(e)=> updateRuleList('complaintRules', i, 'rating', e.target.value)} placeholder="Rating" className="border px-2 py-1 rounded w-20"/>
                    </div>
                    <div className="mt-2 flex gap-2">
                      <input value={r.description || ''} onChange={(e)=> updateRuleList('complaintRules', i, 'description', e.target.value)} placeholder="Description" className="border px-2 py-1 rounded flex-1"/>
                      <button className="px-2 py-1 bg-red-600 text-white rounded" onClick={()=> deleteRule('complaintRules', i)}>Delete</button>
                    </div>
                  </div>
                )) }
              </div>
            </div>

            <div>
              <div className="flex justify-between items-center mb-2">
                <div className="font-semibold"> Frequency Rules</div>
                <button className="px-2 py-1 bg-blue-600 text-white rounded text-sm" onClick={addFreq}>+ Add</button>
              </div>

              <div className="space-y-2">
                { (local.frequencyRules||[]).map((r, i)=> (
                  <div key={r.ruleId} className="border rounded p-2">
                    <div className="flex gap-2">
                      <select value={r.operation} onChange={(e)=> updateRuleList('frequencyRules', i, 'operation', e.target.value)} className="border px-2 py-1 rounded">
                        <option value="in_between">In Between</option>
                        <option value="gte">Greater than or Equal to</option>
                        <option value="lte">Less than or Equal to</option>
                        <option value="gt">Greater than</option>
                        <option value="lt">Less than</option>
                        <option value="eq">Equal to</option>
                      </select>
                      <input type="number" value={r.min ?? ''} onChange={(e)=> updateRuleList('frequencyRules', i, 'min', e.target.value === '' ? null : Number(e.target.value))} placeholder="Min" className="border px-2 py-1 rounded w-20"/>
                      <input type="number" value={r.max ?? ''} onChange={(e)=> updateRuleList('frequencyRules', i, 'max', e.target.value === '' ? null : Number(e.target.value))} placeholder="Max" className="border px-2 py-1 rounded w-20"/>
                      <input type="number" value={r.value ?? ''} onChange={(e)=> updateRuleList('frequencyRules', i, 'value', e.target.value === '' ? null : Number(e.target.value))} placeholder="Value" className="border px-2 py-1 rounded w-20"/>
                    </div>
                    <div className="mt-2 flex gap-2">
                      <select value={r.frequency || 'Monthly'} onChange={(e)=> updateRuleList('frequencyRules', i, 'frequency', e.target.value)} className="border px-2 py-1 rounded">
                        <option>Monthly</option>
                        <option>Yearly</option>
                        <option>Once Every 2 Years</option>
                        <option>Weekly</option>
                        <option>Daily</option>
                      </select>
                      <select value={r.color || '#2563EB'} onChange={(e)=> updateRuleList('frequencyRules', i, 'color', e.target.value)} className="border px-2 py-1 rounded">
                        <option value="#DC2626">Red</option>
                        <option value="#2563EB">Blue</option>
                        <option value="#059669">Green</option>
                        <option value="#1E40AF">Indigo</option>
                        <option value="#7C3AED">Purple</option>
                      </select>
                      <button className="px-2 py-1 bg-red-600 text-white rounded" onClick={()=> deleteRule('frequencyRules', i)}>Delete</button>
                    </div>
                  </div>
                )) }
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  /* ---------- Edit Meta Modal ---------- */
  function EditMetaModal({ meta, onCancel, onSave }){
    const [form, setForm] = useState(meta);
    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center">
        <div className="absolute inset-0 bg-black/40" onClick={onCancel}></div>
        <div className="bg-white rounded-lg shadow-lg w-[640px] p-6 z-10">
          <h3 className="text-lg font-semibold mb-3">Edit Record</h3>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="text-sm">Name</label>
              <input value={form.name} onChange={(e)=> setForm({...form, name: e.target.value})} className="mt-1 w-full border px-3 py-2 rounded"/>
            </div>
            <div>
              <label className="text-sm">Coordinator</label>
              <input value={form.coordinator} onChange={(e)=> setForm({...form, coordinator: e.target.value})} className="mt-1 w-full border px-3 py-2 rounded"/>
            </div>
            <div>
              <label className="text-sm">Applies To</label>
              <select value={form.appliesTo} onChange={(e)=> setForm({...form, appliesTo: e.target.value})} className="mt-1 w-full border px-3 py-2 rounded">
                <option>Line</option><option>Plant</option><option>Supplier</option>
              </select>
            </div>
            <div>
              <label className="text-sm">Applies To Detail</label>
              <input value={form.appliesToDetail} onChange={(e)=> setForm({...form, appliesToDetail: e.target.value})} className="mt-1 w-full border px-3 py-2 rounded"/>
            </div>
            <div className="col-span-2">
              <label className="text-sm">Description</label>
              <textarea value={form.description} onChange={(e)=> setForm({...form, description: e.target.value})} className="mt-1 w-full border px-3 py-2 rounded" rows="3"></textarea>
            </div>
          </div>
          <div className="mt-4 flex justify-end gap-2">
            <button className="px-3 py-1 bg-gray-200 rounded" onClick={onCancel}>Cancel</button>
            <button className="px-3 py-1 bg-blue-600 text-white rounded" onClick={()=> onSave(form)}>Save</button>
          </div>
        </div>
      </div>
    );
  }

  /* ---------- Schedule placeholder ---------- */
  function ScheduleView(){
    const [items, setItems] = useState(loadSchedule());
    function refresh(){ setItems(loadSchedule()); }
    return (
      <div>
        <h1 className="text-2xl font-bold text-blue-700 mb-4">Audit Schedule (Coming Soon)</h1>
        <div className="bg-white rounded shadow p-4">
          <p className="text-sm text-gray-600">Records that have been sent to Schedule are stored in localStorage under <code>{LS_KEYS.SCHEDULE}</code></p>
          <div className="mt-4">
            <button className="px-3 py-1 bg-blue-600 text-white rounded" onClick={refresh}>Show Saved Schedule Records</button>
          </div>
          <div className="mt-4">
            {items.length === 0 ? <div className="text-gray-500">No schedule records yet.</div> : items.map(it => (
              <div key={it.id} className="bg-gray-50 p-3 rounded mb-2">
                <div className="font-medium">{it.name}</div>
                <div className="text-sm text-gray-500">Sent: {it.sentAt}</div>
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  }

  /* ---------- Render ---------- */
  ReactDOM.createRoot(document.getElementById('root')).render(<App />);

  </script>
</body>
</html>
