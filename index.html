import { Component, signal, computed } from '@angular/core';

@Component({
  selector: 'app-root',
  standalone: true,
  template: `
    <div class="bg-gray-100 min-h-screen p-4 sm:p-8 flex items-center justify-center">
      <div class="w-full max-w-7xl mx-auto bg-white rounded-2xl shadow-xl p-6 sm:p-8 space-y-8">

        <header class="text-center space-y-2">
          <h1 class="text-4xl font-extrabold text-gray-800 tracking-tight">Audit Module</h1>
          <h2 class="text-2xl font-semibold text-gray-600">Decision Table</h2>
        </header>

        <main class="space-y-6">
          <div class="table-container rounded-lg border border-gray-200 overflow-hidden shadow-sm">
            <table class="styled-table min-w-full">
              <thead>
                <tr>
                  <th class="w-24">Actions</th>
                  <th>Line</th>
                  <th>Target</th>
                  <th>Assembly PPM</th>
                  <th>% Change</th>
                  <th>Rating (% Change)</th>
                  <th>Customer Complaints</th>
                  <th>Rating (Complaints)</th>
                  <th>Final Rating</th>
                  <th>Frequency</th>
                </tr>
              </thead>
              <tbody>
                @for (row of fullTableData(); track $index) {
                  <tr>
                    <td>
                      <button (click)="deleteRow($index)" class="bg-red-500 text-white rounded-md p-1 hover:bg-red-600 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.214 21H7.786a2 2 0 01-1.927-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                      </button>
                    </td>
                    <td>
                      <select (change)="updateLine($event, $index)" [value]="row.line" class="w-full border-none outline-none p-0 text-gray-800 bg-transparent">
                        <option value="" disabled selected>Select Line</option>
                        @for (line of lines; track line) {
                          <option [value]="line">{{ line }}</option>
                        }
                      </select>
                    </td>
                    <td><input type="text" [value]="row.target" disabled class="data-cell disabled:bg-gray-100 text-gray-500 cursor-not-allowed"></td>
                    <td><input type="number" (input)="updatePPM($event, $index)" [value]="row.assemblyPPM" placeholder="Enter value..." class="data-cell"></td>
                    <td><input type="text" [value]="row.change.toFixed(2) + '%'" disabled class="data-cell disabled:bg-gray-100 text-gray-500 cursor-not-allowed"></td>
                    <td><input type="text" [value]="row.ratingChange" disabled class="data-cell disabled:bg-gray-100 text-gray-500 cursor-not-allowed"></td>
                    <td><input type="number" (input)="updateComplaints($event, $index)" [value]="row.customerComplaints" placeholder="Enter count..." class="data-cell"></td>
                    <td><input type="text" [value]="row.ratingComplaints" disabled class="data-cell disabled:bg-gray-100 text-gray-500 cursor-not-allowed"></td>
                    <td><input type="text" [value]="row.finalRating" disabled class="data-cell disabled:bg-gray-100 text-gray-500 cursor-not-allowed"></td>
                    <td><input type="text" [value]="row.frequency" disabled class="data-cell disabled:bg-gray-100 text-gray-500 cursor-not-allowed"></td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-col sm:flex-row gap-4">
            <button (click)="addRow()" class="flex-1 py-3 px-6 bg-indigo-600 text-white font-medium rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
              Add Row
            </button>
          </div>
        </main>
      </div>
    </div>
  `,
  styles: [`
    body {
        font-family: 'Inter', sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    .table-container {
        overflow-x: auto;
    }
    .styled-table {
        border-collapse: separate;
        border-spacing: 0;
    }
    .styled-table th, .styled-table td {
        border: 1px solid #e5e7eb;
        padding: 12px 15px;
        text-align: left;
    }
    .styled-table th {
        background-color: #f3f4f6;
        font-weight: 600;
        color: #1f2937;
        text-transform: uppercase;
        white-space: nowrap;
    }
    .styled-table td {
        background-color: #ffffff;
        transition: background-color 0.2s ease-in-out;
        white-space: nowrap;
    }
    .styled-table tr:hover td {
        background-color: #f9fafb;
    }
    .styled-table input, .styled-table select {
        width: 100%;
        min-width: 100px;
        border: none;
        outline: none;
        padding: 0;
        background-color: transparent;
        font-size: inherit;
        color: inherit;
    }
    /* Custom scrollbar for table container */
    .table-container::-webkit-scrollbar {
        height: 8px;
        background-color: #f1f1f1;
    }
    .table-container::-webkit-scrollbar-thumb {
        background-color: #d1d5db;
        border-radius: 4px;
    }
    .table-container::-webkit-scrollbar-thumb:hover {
        background-color: #9ca3af;
    }
  `],
})
export class App {
  readonly TARGET = 4600;
  readonly lines = ['Line A', 'Line B', 'Line C', 'Line D', 'Line E', 'Line F'];

  // Define the base table data using a signal. It holds the raw input values.
  tableData = signal<any[]>([
    {
      line: 'Line A',
      target: this.TARGET,
      assemblyPPM: 5000,
      customerComplaints: 0,
    },
    {
      line: 'Line B',
      target: this.TARGET,
      assemblyPPM: 6900,
      customerComplaints: 1,
    },
    {
      line: 'Line C',
      target: this.TARGET,
      assemblyPPM: 4600,
      customerComplaints: 2,
    },
    {
      line: 'Line D',
      target: this.TARGET,
      assemblyPPM: 4800,
      customerComplaints: 0,
    },
    {
      line: 'Line E',
      target: this.TARGET,
      assemblyPPM: 7000,
      customerComplaints: 5,
    },
    {
      line: 'Line F',
      target: this.TARGET,
      assemblyPPM: 5500,
      customerComplaints: 1,
    },
  ]);

  // Use a computed signal to create a reactive, transformed view of the table data
  fullTableData = computed(() => {
    return this.tableData().map(row => {
      // Calculation for % Change
      const change = (row.target !== 0) ? ((row.assemblyPPM - row.target) / row.target) * 100 : 0;
      
      // Calculation for Rating (% Change)
      const ratingChange = (() => {
        if (change <= 0) return 5;
        if (change > 0 && change <= 50) return 3;
        return 1;
      })();
      
      // Calculation for Rating (Customer Complaints)
      const ratingComplaints = (() => {
        const complaints = row.customerComplaints;
        if (complaints === 0) return 5;
        if (complaints === 1) return 3;
        return 1;
      })();
      
      // Calculation for Final Rating
      const finalRating = ratingChange * ratingComplaints;
      
      // Calculation for Frequency
      const frequency = finalRating === 25 ? 'Once' : 'Twice';

      return {
        ...row,
        change,
        ratingChange,
        ratingComplaints,
        finalRating,
        frequency,
      };
    });
  });

  // Function to update Assembly PPM. It updates the base signal, which in turn updates the computed signal.
  updatePPM(event: Event, index: number) {
    const value = Number((event.target as HTMLInputElement).value);
    this.tableData.update(rows => {
      rows[index].assemblyPPM = value;
      return [...rows];
    });
  }

  // Function to update Customer Complaints.
  updateComplaints(event: Event, index: number) {
    const value = Number((event.target as HTMLInputElement).value);
    this.tableData.update(rows => {
      rows[index].customerComplaints = value;
      return [...rows];
    });
  }

  // Function to update the Line dropdown.
  updateLine(event: Event, index: number) {
    const value = (event.target as HTMLSelectElement).value;
    this.tableData.update(rows => {
      rows[index].line = value;
      return [...rows];
    });
  }

  // Add a new row with default values
  addRow() {
    const newRow = {
      line: '',
      target: this.TARGET,
      assemblyPPM: 0,
      customerComplaints: 0,
    };
    this.tableData.update(rows => [...rows, newRow]);
  }

  // Delete a row
  deleteRow(index: number) {
    this.tableData.update(rows => {
      const updatedRows = [...rows];
      updatedRows.splice(index, 1);
      return updatedRows;
    });
  }
}
