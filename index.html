import React, { useState, useEffect, useCallback } from 'react';
import { Briefcase, CalendarCheck, ClipboardList, Pencil, CheckCircle, Trash2, Settings, Eye, ArrowLeft, Download, Upload, Plus, Save } from 'lucide-react';

// --- Data Structures (Mock Data) ---

// Line options for the dropdown
const LINE_OPTIONS = ['Production Line', 'Assembly Line', 'Quality Check', 'Packaging', 'Shipping'];

// Initial Mock data for the Audit Records Listing
const AuditRecordsData = [
  { id: 1, name: 'Q1 Financial Review', coordinators: ['Alice Johnson', 'Bob Smith'], auditee: 'Internal', status: 'New', matrixData: [
    { id: 101, line: 'Production Line', target: 100, actualPPM: 120, complaints: 1 },
    { id: 102, line: 'Assembly Line', target: 50, actualPPM: 40, complaints: 0 },
    { id: 103, line: 'Quality Check', target: 10, actualPPM: 15, complaints: 5 },
  ]},
  { id: 2, name: 'Vendor Security Assessment', coordinators: ['Bob Smith'], auditee: 'Supplier', status: 'New', matrixData: [] },
  { id: 3, name: 'Marketing Compliance', coordinators: ['Diana Prince', 'Alice Johnson', 'Charlie Brown'], auditee: 'Internal', status: 'New', matrixData: [] },
];

// Mock data for the Audit Schedule (kept for the second tab)
const ScheduleData = [
  { id: 101, title: 'Annual Financial Review', startDate: '2024-10-01', endDate: '2024-10-31', status: 'In Progress', lead: 'J. Smith' },
  { id: 102, title: 'Cloud Security Assessment', startDate: '2025-01-15', endDate: '2025-03-30', status: 'Planned', lead: 'A. Chen' },
  { id: 103, title: 'Vendor Compliance Check', startDate: '2024-12-01', endDate: '2024-12-15', status: 'Awaiting Kickoff', lead: 'M. Lee' },
];

// --- Calculation Logic (Utility Functions) ---

const calculateMetrics = (target, actualPPM, complaints) => {
    target = Number(target) || 0;
    actualPPM = Number(actualPPM) || 0;
    complaints = Number(complaints) || 0;

    // 1. % Change
    const change = target === 0 ? 0 : ((actualPPM - target) / target) * 100;
    const changeStr = `${change.toFixed(1)}%`;

    // 2. % Change Rating
    let changeRating;
    if (change <= 0) {
        changeRating = 5; // Excellent performance* (≤ 0%)
    } else if (change > 0 && change < 20) {
        changeRating = 3; // Good performance* (0% < δ < 20%)
    } else {
        changeRating = 1; // Poor performance* (≥ 20%)
    }

    // 3. Customer Complaints Rating
    let complaintsRating;
    if (complaints === 0) {
        complaintsRating = 5; // No customer issues* (0 complaints)
    } else if (complaints >= 1 && complaints <= 2) {
        // Adjusted to 1-2 to avoid ambiguity with the next category starting at 3
        complaintsRating = 3; // Minor customer issues* (1-2 complaints)
    } else {
        complaintsRating = 1; // Major customer issues* (≥ 3 complaints)
    }

    // 4. Final Rating
    const finalRating = changeRating * complaintsRating;

    // 5. Frequency
    let frequency;
    if (finalRating >= 15) {
        frequency = 'Annually'; // High Priority
    } else if (finalRating >= 9 && finalRating <= 14) {
        frequency = 'Quarterly'; // Medium Priority
    } else {
        frequency = 'Weekly'; // Regular Audit (≤ 8)
    }

    return {
        change: changeStr,
        changeRating,
        complaintsRating,
        finalRating,
        frequency,
    };
};

// --- Utility Components ---

/**
 * Renders an Auditee or Status badge with appropriate color.
 */
const Badge = ({ children, type }) => {
    let colorClasses = '';
    if (type === 'Auditee') {
        colorClasses = children === 'Internal' ? 'bg-indigo-100 text-indigo-700' : 'bg-pink-100 text-pink-700';
    } else if (type === 'Status') {
        colorClasses = children === 'New' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700';
    } else if (type === 'Frequency') {
        colorClasses = children === 'Annually' ? 'bg-red-100 text-red-800' :
                       children === 'Quarterly' ? 'bg-orange-100 text-orange-800' :
                       'bg-green-100 text-green-800';
    }

    return (
        <span className={`px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${colorClasses}`}>
            {children}
        </span>
    );
};

// --- Row Component for Matrix Data ---

/**
 * Renders a single, editable row in the Audit Decision Matrix table.
 */
// Added initialIsEditing prop to allow new rows to start in edit mode
const MatrixRow = ({ initialData, initialIsEditing = false, onSave, onDelete }) => {
    const [isEditing, setIsEditing] = useState(initialIsEditing);
    const [editData, setEditData] = useState(initialData);

    // Recalculate metrics whenever target, actualPPM, or complaints change
    const metrics = calculateMetrics(editData.target, editData.actualPPM, editData.complaints);
    
    // Merge calculated metrics back into the row data for display
    const rowData = { ...editData, ...metrics };

    const handleChange = (e) => {
        const { name, value } = e.target;
        setEditData(prev => ({
            ...prev,
            [name]: name === 'target' || name === 'actualPPM' || name === 'complaints'
                // Allow empty string ('') for empty input fields, but enforce non-negative numbers otherwise.
                ? (value === '' ? '' : Math.max(0, Number(value))) 
                : value
        }));
    };

    const handleSave = () => {
        // Prepare the data to be sent back to the parent component/database
        const cleanedData = {
            ...rowData,
            // Convert potential empty strings back to 0 for storage/calculations
            target: Number(rowData.target) || 0, 
            actualPPM: Number(rowData.actualPPM) || 0,
            complaints: Number(rowData.complaints) || 0,
        };
        
        // Remove the temporary 'isNew' flag used for initial editing state
        if (cleanedData.isNew) {
            delete cleanedData.isNew;
        }

        onSave(rowData.id, cleanedData);
        setIsEditing(false);
    };

    const handleEdit = () => {
        setIsEditing(true);
    };

    return (
        <tr className="hover:bg-gray-50 transition duration-150">
            {/* 1. LINE (Dropdown/Text) */}
            <td className="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                {isEditing ? (
                    <select
                        name="line"
                        value={editData.line}
                        onChange={handleChange}
                        className="p-1 border border-gray-300 rounded-md w-full focus:ring-indigo-500 focus:border-indigo-500"
                    >
                        {LINE_OPTIONS.map(line => (
                            <option key={line} value={line}>{line}</option>
                        ))}
                    </select>
                ) : (
                    rowData.line
                )}
            </td>

            {/* 2. TARGET (Numeric Input) */}
            <td className="px-3 py-3 whitespace-nowrap text-sm text-gray-500">
                {isEditing ? (
                    <input
                        type="number"
                        name="target"
                        value={editData.target}
                        onChange={handleChange}
                        min="0"
                        placeholder="0"
                        className="p-1 border border-gray-300 rounded-md w-24 text-center focus:ring-indigo-500 focus:border-indigo-500"
                    />
                ) : (
                    rowData.target
                )}
            </td>

            {/* 3. ASSEMBLY PPM (Numeric Input) */}
            <td className="px-3 py-3 whitespace-nowrap text-sm text-gray-500">
                {isEditing ? (
                    <input
                        type="number"
                        name="actualPPM"
                        value={editData.actualPPM}
                        onChange={handleChange}
                        min="0"
                        placeholder="0"
                        className="p-1 border border-gray-300 rounded-md w-24 text-center focus:ring-indigo-500 focus:border-indigo-500"
                    />
                ) : (
                    rowData.actualPPM
                )}
            </td>

            {/* 4. % CHANGE (Auto Calculate) */}
            <td className="px-3 py-3 whitespace-nowrap text-sm font-semibold text-indigo-600">
                {rowData.change}
            </td>

            {/* 5. RATING (% Change) (Auto Calculate) */}
            <td className="px-3 py-3 whitespace-nowrap text-sm text-gray-900 font-semibold text-center">
                {rowData.changeRating}
            </td>

            {/* 6. CUSTOMER COMPLAINTS (Numeric Input) */}
            <td className="px-3 py-3 whitespace-nowrap text-sm text-gray-500 text-center">
                {isEditing ? (
                    <input
                        type="number"
                        name="complaints"
                        value={editData.complaints}
                        onChange={handleChange}
                        min="0"
                        placeholder="0"
                        className="p-1 border border-gray-300 rounded-md w-24 text-center focus:ring-indigo-500 focus:border-indigo-500"
                    />
                ) : (
                    rowData.complaints
                )}
            </td>

            {/* 7. RATING (Complaints) (Auto Calculate) */}
            <td className="px-3 py-3 whitespace-nowrap text-sm text-gray-900 font-semibold text-center">
                {rowData.complaintsRating}
            </td>

            {/* 8. FINAL RATING (Auto Calculate) */}
            <td className="px-3 py-3 whitespace-nowrap text-sm text-gray-900 font-extrabold text-center">
                {rowData.finalRating}
            </td>

            {/* 9. FREQUENCY (Auto Calculate) */}
            <td className="px-3 py-3 whitespace-nowrap text-sm font-medium">
                <Badge type="Frequency">{rowData.frequency}</Badge>
            </td>

            {/* 10. ACTIONS (Edit/Save & Delete) */}
            <td className="px-3 py-3 whitespace-nowrap text-sm font-medium text-center">
                <div className="flex space-x-3 justify-center">
                    {isEditing ? (
                        <button 
                            onClick={handleSave} 
                            className="text-green-500 hover:text-green-600 transition p-1 rounded-full hover:bg-green-50" 
                            title="Save Row"
                        >
                            <Save className="w-4 h-4" />
                        </button>
                    ) : (
                        <button 
                            onClick={handleEdit} 
                            className="text-indigo-500 hover:text-indigo-600 transition p-1 rounded-full hover:bg-indigo-50" 
                            title="Edit Row"
                        >
                            <Pencil className="w-4 h-4" />
                        </button>
                    )}
                    <button 
                        onClick={() => onDelete(rowData.id)} 
                        className="text-red-500 hover:text-red-600 transition p-1 rounded-full hover:bg-red-50" 
                        title="Delete Row"
                    >
                        <Trash2 className="w-4 h-4" />
                    </button>
                </div>
            </td>
        </tr>
    );
};


// --- Main View Components ---

/**
 * Renders the detailed Audit Decision Matrix for a specific record.
 * @param {object} props
 * @param {string} props.auditName - The name of the audit (e.g., 'Q1 Financial Review')
 * @param {function} props.onBack - Function to return to the listing page
 * @param {object[]} props.initialMatrixData - The initial matrix data for this audit
 */
const AuditDecisionMatrixDetail = ({ auditName, onBack, initialMatrixData }) => {
    // State for the matrix data rows
    const [matrixData, setMatrixData] = useState(initialMatrixData || []);
    // Ensure nextId starts higher than existing IDs (including those in matrixData, or 1 if empty)
    const [nextId, setNextId] = useState(
        (initialMatrixData && initialMatrixData.length > 0) 
            ? Math.max(...initialMatrixData.map(d => d.id)) + 1 
            : 1
    );

    const handleSaveRow = useCallback((id, updatedData) => {
        // Destructure and remove the temporary 'isNew' flag from the data object
        const { isNew, ...dataToSave } = updatedData;

        setMatrixData(prev => prev.map(row => 
            row.id === id 
                ? { ...dataToSave } // Save the cleaned data without 'isNew'
                : row
        ));
        // In a real app, you would send dataToSave to Firestore here.
        console.log(`Row ${id} saved:`, dataToSave);
    }, []);

    const handleDeleteRow = useCallback((id) => {
        setMatrixData(prev => prev.filter(row => row.id !== id));
        // In a real app, you would delete the record in Firestore here.
        console.log(`Row ${id} deleted.`);
    }, []);
    
    const handleAddRow = () => {
        const newRow = {
            id: nextId,
            line: LINE_OPTIONS[0],
            target: '', // Empty string to show an empty field
            actualPPM: '', // Empty string to show an empty field
            complaints: '', // Empty string to show an empty field
            isNew: true, // Flag to indicate this row should start in edit mode
        };
        setMatrixData(prev => [...prev, newRow]);
        setNextId(prev => prev + 1);
        // In a real app, you would add the new record to Firestore here.
        console.log('New row added:', newRow);
    };

    // Helper for table rendering
    const tableHeaders = ['LINE', 'TARGET', 'ASSEMBLY PPM', '% CHANGE', 'RATING', 'CUSTOMER COMPLAINTS', 'RATING', 'FINAL RATING', 'FREQUENCY', 'ACTIONS'];


    return (
        <div className="p-4 sm:p-6 bg-white rounded-xl shadow-lg">
            {/* Header with Back Button */}
            <div className="flex items-center mb-6 pb-4 border-b">
                <button onClick={onBack} className="text-gray-500 hover:text-indigo-600 transition mr-4 p-2 rounded-full hover:bg-gray-100">
                    <ArrowLeft className="w-6 h-6" />
                </button>
                <h2 className="text-2xl font-bold text-gray-800 flex-1">
                    Audit Decision Matrix: <span className="text-indigo-600">{auditName}</span>
                </h2>
            </div>

            {/* Rating Guidelines Section */}
            <div className="bg-indigo-50 p-6 rounded-xl mb-8 relative">
                <div className="flex justify-between items-start mb-4">
                    <h3 className="text-xl font-semibold text-gray-800">Rating Guidelines</h3>
                    <button className="flex items-center px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition">
                        Configure
                    </button>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                    <div>
                        <h4 className="font-bold text-gray-700 mb-2">% Change Rating:</h4>
                        <ul className="list-disc list-inside space-y-1 text-gray-600">
                            {/* Guidelines for % Change Rating */}
                            <li>**5** - Excellent performance* (&le; 0%)</li>
                            <li>**3** - Good performance* (0% &lt; &delta; &lt; 20%)</li>
                            <li className="text-red-600">**1** - Poor performance* (&ge; 20%)</li>
                        </ul>
                    </div>
                    <div>
                        <h4 className="font-bold text-gray-700 mb-2">Customer Complaints Rating:</h4>
                        <ul className="list-disc list-inside space-y-1 text-gray-600">
                            {/* Guidelines for Complaint Rating (Adjusted to be non-ambiguous: 1-2 for rating 3) */}
                            <li>**5** - No customer issues* (0 complaints)</li>
                            <li>**3** - Minor customer issues* (1-2 complaints)</li>
                            <li className="text-red-600">**1** - Major customer issues* (&ge; 3 complaints)</li>
                        </ul>
                    </div>
                    <div>
                        <h4 className="font-bold text-gray-700 mb-2">Frequency Mapping:</h4>
                        <ul className="list-disc list-inside space-y-1 text-gray-600">
                            {/* Guidelines for Final Rating to Frequency Mapping */}
                            <li>**Annually** - Final Rating &ge; 15 (High Priority)</li>
                            <li>**Quarterly** - Final Rating 9-14 (Medium Priority)</li>
                            <li>**Weekly** - Final Rating &le; 8 (Regular Audit)</li>
                        </ul>
                    </div>
                </div>
            </div>

            {/* Matrix Data Section */}
            <h3 className="text-xl font-semibold text-gray-800 mb-4">Matrix Data</h3>
            
            <div className="flex flex-col sm:flex-row justify-end sm:justify-between items-start sm:items-center mb-4 space-y-3 sm:space-y-0 sm:space-x-3">
                <input 
                    type="text" 
                    placeholder="Search..."
                    className="w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition"
                />
                <div className="flex space-x-3 w-full sm:w-auto">
                    <button className="flex items-center px-3 py-2 text-sm text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                        <Download className="w-4 h-4 mr-2" /> Download Import Format
                    </button>
                    <button className="flex items-center px-3 py-2 text-sm text-green-700 bg-green-100 rounded-lg hover:bg-green-200 transition font-medium">
                        <Upload className="w-4 h-4 mr-2" /> Excel Import
                    </button>
                    <button 
                        onClick={handleAddRow}
                        className="flex items-center px-3 py-2 text-sm text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition font-medium"
                    >
                        <Plus className="w-4 h-4 mr-1" /> Add
                    </button>
                </div>
            </div>

            {/* Data Table */}
            <div className="overflow-x-auto border border-gray-200 rounded-lg">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            {tableHeaders.map((header, index) => (
                                <th key={index} className="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    {header}
                                </th>
                            ))}
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {matrixData.map((item) => (
                            <MatrixRow
                                key={item.id}
                                // If the item has the 'isNew' flag, start it in edit mode
                                initialIsEditing={!!item.isNew} 
                                initialData={item}
                                onSave={handleSaveRow}
                                onDelete={handleDeleteRow}
                            />
                        ))}
                        {matrixData.length === 0 && (
                            <tr>
                                <td colSpan={10} className="text-center py-6 text-gray-500">
                                    No matrix data available. Click 'Add' to start.
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
            
        </div>
    );
};


/**
 * Renders the Audit Records Listing view.
 * @param {object} props
 * @param {function} props.onViewDetails - Function to navigate to the detail page
 */
const AuditRecordsListing = ({ onViewDetails }) => (
  <div className="p-4 sm:p-6 bg-white rounded-xl shadow-lg">
    <div className="flex justify-between items-center mb-6 border-b pb-4">
        <h2 className="text-2xl font-bold text-gray-800 flex items-center">
            <ClipboardList className="w-6 h-6 mr-3 text-indigo-600" />
            Audit Records Listing
        </h2>
        <button className="flex items-center px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition">
            <Pencil className="w-4 h-4 mr-2" />
            Create New Record
        </button>
    </div>
    
    <p className="text-sm text-gray-600 mb-6">
      <span className="font-semibold text-indigo-600">Displaying only the latest 3 records for brevity.</span> Manage all auditable records and their associated risk profile (to be implemented).
    </p>

    <div className="overflow-x-auto">
      <table className="min-w-full divide-y divide-gray-200">
        <thead className="bg-gray-50">
          <tr>
            {['NAME', 'COORDINATORS', 'AUDITEE', 'STATUS', 'ACTIONS'].map((header) => (
              <th key={header} className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                {header}
              </th>
            ))}
          </tr>
        </thead>
        <tbody className="bg-white divide-y divide-gray-200">
          {AuditRecordsData.map((item) => (
            <tr key={item.id} className="hover:bg-indigo-50 transition duration-150">
              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                {item.name}
              </td>
              <td className="px-6 py-4 whitespace-normal text-sm text-gray-500 max-w-xs">
                {item.coordinators.join(', ')}
              </td>
              <td className="px-6 py-4 whitespace-nowrap text-sm">
                <Badge type="Auditee">{item.auditee}</Badge>
              </td>
              <td className="px-6 py-4 whitespace-nowrap text-sm">
                <Badge type="Status">{item.status}</Badge>
              </td>
              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div className="flex space-x-3 text-gray-500">
                    {/* 1. Edit Action */}
                    <button className="text-indigo-500 hover:text-indigo-600 transition" title="Edit Record">
                        <Pencil className="w-4 h-4" />
                    </button>
                    {/* 2. View Action - Triggers the page change */}
                    <button 
                        onClick={() => onViewDetails(item.id, item.name, item.matrixData)} 
                        className="text-green-500 hover:text-green-600 transition" 
                        title="View Details"
                    >
                        <Eye className="w-4 h-4" />
                    </button>
                    {/* 3. Delete Action */}
                    <button className="text-red-500 hover:text-red-600 transition" title="Delete Record">
                        <Trash2 className="w-4 h-4" />
                    </button>
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </div>
);

/**
 * Renders the Audit Schedule view. (Content unchanged)
 */
const AuditSchedule = () => (
  <div className="p-6 bg-white rounded-xl shadow-lg">
    <h2 className="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Audit Schedule</h2>
    <p className="text-gray-600 mb-4">
      Upcoming and ongoing audit projects with key dates and status updates.
    </p>

    <div className="space-y-4">
      {ScheduleData.map((audit) => (
        <div key={audit.id} className="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 border border-gray-100 rounded-lg hover:border-indigo-400 transition duration-150 ease-in-out">
          <div className="flex-1 min-w-0 mb-2 sm:mb-0">
            <p className="text-lg font-semibold text-gray-900 truncate">{audit.title}</p>
            <p className="text-sm text-gray-500">Lead: {audit.lead}</p>
          </div>
          <div className="flex items-center space-x-4">
            <div className="text-right">
              <p className="text-sm font-medium text-gray-700">Dates</p>
              <p className="text-xs text-gray-500">{audit.startDate} - {audit.endDate}</p>
            </div>
            <span className={`px-4 py-1.5 inline-flex text-sm leading-5 font-semibold rounded-full ${
              audit.status === 'In Progress' ? 'bg-indigo-100 text-indigo-800' :
              audit.status === 'Planned' ? 'bg-green-100 text-green-800' :
              'bg-yellow-100 text-yellow-800'
            }`}>
              {audit.status}
            </span>
          </div>
        </div>
      ))}
    </div>
    <button className="mt-6 w-full sm:w-auto px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition">
        Add New Audit
    </button>
  </div>
);

/**
 * Navigation item component
 */
const NavItem = ({ icon: Icon, label, isActive, onClick }) => (
  <button
    onClick={onClick}
    className={`
      flex items-center w-full px-4 py-3 rounded-xl transition duration-200 ease-in-out
      ${isActive
        ? 'bg-white/20 text-white' 
        : 'text-indigo-200 hover:bg-white/10'
      }
    `}
  >
    <Icon className="w-5 h-5 mr-3" />
    <span className="font-medium">{label}</span>
  </button>
);

/**
 * Main application component, handling navigation logic.
 */
const App = () => {
  // State to manage the active main view ('Records', 'Schedule', or 'Detail')
  const [activeView, setActiveView] = useState('Records'); 
  // State to hold data for the currently viewed record detail
  const [currentAudit, setCurrentAudit] = useState(null); 

  // Function to navigate to the detailed matrix view
  const handleViewDetails = (id, name, matrixData) => {
    setCurrentAudit({ id, name, matrixData });
    setActiveView('Detail');
  };

  // Function to navigate back to the listing view
  const handleBackToListing = () => {
    setCurrentAudit(null);
    setActiveView('Records');
  };

  // Function to render the correct content component
  const renderContent = () => {
    switch (activeView) {
      case 'Records':
        return <AuditRecordsListing onViewDetails={handleViewDetails} />;
      case 'Schedule':
        return <AuditSchedule />;
      case 'Detail':
        // Ensure we have data before rendering the detail page
        if (currentAudit) {
            return (
                <AuditDecisionMatrixDetail 
                    auditName={currentAudit.name} 
                    initialMatrixData={currentAudit.matrixData}
                    onBack={handleBackToListing} 
                />
            );
        }
        return <AuditRecordsListing onViewDetails={handleViewDetails} />; // Fallback
      default:
        return <AuditRecordsListing onViewDetails={handleViewDetails} />;
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 flex" style={{ fontFamily: 'Inter, sans-serif' }}>
      
      {/* 1. Sidebar Navigation (Modified to match the screenshot's dark purple style) */}
      <nav className="hidden md:flex flex-col w-64 bg-indigo-900 p-4 shadow-2xl">
        <div className="flex items-center text-white text-xl font-bold mb-10 tracking-wider h-16 border-b border-white/10">
            <CheckCircle className="w-6 h-6 mr-2 text-green-400" />
            Audit Planner
        </div>

        <div className="space-y-2 flex-1">
          <NavItem
            icon={ClipboardList}
            label="Audit Records"
            isActive={activeView === 'Records' || activeView === 'Detail'} // Highlight Records when viewing a detail
            onClick={handleBackToListing} // Clicking records takes you back to the list
          />
          <NavItem
            icon={CalendarCheck}
            label="Audit Schedule"
            isActive={activeView === 'Schedule'}
            onClick={() => setActiveView('Schedule')}
          />
        </div>

        {/* Settings button at the bottom */}
        <div className="pt-4 border-t border-white/10">
             <button className="flex items-center w-full px-4 py-3 rounded-xl text-indigo-200 hover:bg-white/10 transition">
                <Settings className="w-5 h-5 mr-3" />
                <span className="font-medium">Settings</span>
            </button>
        </div>
      </nav>

      {/* 2. Main Content Area */}
      <main className="flex-1 p-4 md:p-8 overflow-y-auto">
        
        {/* Mobile Header/Navigation */}
        <header className="md:hidden sticky top-0 z-10 bg-white p-4 mb-4 rounded-xl shadow-md">
          <h1 className="text-xl font-bold text-gray-800 mb-3">Audit Planner</h1>
          <div className="flex space-x-2">
             <button
                className={`flex-1 py-2 px-3 text-sm font-medium rounded-lg transition ${activeView === 'Records' || activeView === 'Detail' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                onClick={handleBackToListing}
            >
                Audit Records
            </button>
            <button
                className={`flex-1 py-2 px-3 text-sm font-medium rounded-lg transition ${activeView === 'Schedule' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                onClick={() => setActiveView('Schedule')}
            >
                Audit Schedule
            </button>
          </div>
        </header>

        <div className="w-full max-w-7xl mx-auto">
          {/* Render the active content view */}
          {renderContent()}
        </div>

      </main>
    </div>
  );
};

export default App;
